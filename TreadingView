<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>TradingView UAE Stocks</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; direction: rtl; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    tr:nth-child(even) { background: #fafafa; }
    .update-time { margin-top: 10px; text-align: center; font-size: 14px; color: #555; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Ø£Ø³Ù‡Ù… Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª (DFM + ADX)</h1>
  <div class="update-time" id="updateTime">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</div>
  <table id="stockTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø±Ù…Ø²</th>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø¨ÙˆØ±ØµØ©</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ØªØºÙŠÙŠØ± %</th>
        <th>Ø§Ù„Ø­Ø¬Ù…</th>
        <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadData() {
      const endpoint = "https://scanner.tradingview.com/middle_east/scan"; 
      const payload = {
        filter: [
          { left: "type", operation: "in_range", right: ["stock"] },
          { left: "exchange", operation: "in_range", right: ["DFM","ADX"] }
        ],
        options: { lang: "en" },
        symbols: { query: { types: [] }, tickers: [] },
        columns: [
          "name", "short_name", "exchange", "close", "change", "volume", "market_cap_basic"
        ],
        sort: { sortBy: "name", sortOrder: "asc" },
        range: [0, 500]
      };

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        renderTable(json.data);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
        const now = new Date().toLocaleTimeString("ar-AE");
        document.getElementById("updateTime").innerText = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + now;
      } catch (err) {
        console.error("Ø®Ø·Ø£:", err);
        document.getElementById("updateTime").innerText = "âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      }
    }

    function renderTable(rows) {
      const tbody = document.querySelector("#stockTable tbody");
      tbody.innerHTML = "";

      rows.forEach(item => {
        let sym = item.s || item.name;
        let d   = item.d || [];
        const cols = item.d ? {
          name: sym,
          short_name: d[1],
          exchange: d[2],
          close: d[3],
          change: d[4],
          volume: d[5],
          market_cap_basic: d[6]
        } : item;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${cols.name}</td>
          <td>${cols.short_name || "-"}</td>
          <td>${cols.exchange || "-"}</td>
          <td>${cols.close || "-"}</td>
          <td style="color:${cols.change>=0 ? 'green':'red'};">
            ${cols.change != null ? cols.change.toFixed(2) : "-"}
          </td>
          <td>${cols.volume || "-"}</td>
          <td>${cols.market_cap_basic || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    loadData();
    // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©
    setInterval(loadData, 60000);
  </script>
</body>
</html>
