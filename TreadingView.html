<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’¼ Ù…Ù†ØµØ© Ù…Ø­ÙØ¸ØªÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: 'Tahoma', sans-serif; margin:20px; background:#f5f5f5; color:#333;}
    h1 {text-align:center;}
    .controls {text-align:center; margin-bottom:10px;}
    .btn {padding:6px 12px; margin:3px; border:none; border-radius:6px; cursor:pointer;}
    .btn.ghost {background:#eee;}
    .btn.danger {background:#e74c3c; color:#fff;}
    .btn.flat {background:#3498db; color:#fff;}
    .kpis {display:flex; justify-content:space-around; margin:20px 0; flex-wrap:wrap;}
    .kpi {background:#fff; padding:10px 20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin:5px;}
    table {width:100%; border-collapse:collapse; margin-top:20px; background:#fff;}
    th, td {border:1px solid #ccc; padding:6px; text-align:center;}
    th {background:#eee;}
    tfoot td {font-weight:bold; background:#fafafa;}
    .positive {color:green;}
    .negative {color:red;}
    .filters {margin:10px 0; display:flex; gap:10px; flex-wrap:wrap;}
    .dashboard {display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:30px;}
    .chart-container {background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  </style>
</head>
<body>
  <h1>ğŸ’¼ Ù…Ù†ØµØ© Ù…Ø­ÙØ¸ØªÙŠ</h1>
  <div class="controls">
    <button class="btn flat" id="toggleTheme">ğŸŒ— ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„/Ø§Ù„Ù†Ù‡Ø§Ø±</button>
    <button class="btn ghost" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
    <label class="btn ghost" for="importFile" style="cursor:pointer">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
    <input id="importFile" type="file" accept="application/json" hidden>
    <button class="btn danger" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
  </div>

  <div class="kpis" id="kpis">
    <div class="kpi"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</div><div class="value" id="kpiValue">â€”</div></div>
    <div class="kpi"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</div><div class="value" id="kpiCost">â€”</div></div>
    <div class="kpi"><div class="label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div><div class="value" id="kpiPnL">â€”</div></div>
    <div class="kpi"><div class="label">Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ„ÙŠ</div><div class="value" id="kpiReturn">â€”</div></div>
  </div>

  <div class="filters" id="columnFilters"></div>
  <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø«: Ø±Ù…Ø²/Ø§Ø³Ù…" style="width:100%;padding:8px;">

  <table id="portfolioTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø±Ù…Ø²</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
        <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
        <th>Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„</th>
        <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
        <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        <th>Ø§Ù„Ø±Ø¨Ø­</th>
        <th>Ø§Ù„ØªØºÙŠÙŠØ± %</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
    <tfoot>
      <tr>
        <td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
        <td id="sumQty">â€”</td>
        <td id="avgBuy">â€”</td>
        <td>â€”</td>
        <td id="sumTrade">â€”</td>
        <td id="sumCost">â€”</td>
        <td id="sumValue">â€”</td>
        <td id="sumProfit">â€”</td>
        <td>â€”</td>
      </tr>
    </tfoot>
  </table>

  <div class="dashboard">
    <div class="chart-container">
      <h3>ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù…</h3>
      <canvas id="qtyChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ğŸ’° ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</h3>
      <canvas id="valChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ğŸ’µ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„</h3>
      <canvas id="tradeChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ğŸ’¸ Ø§Ù„ØªÙƒÙ„ÙØ©</h3>
      <canvas id="costChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ğŸ·ï¸ Ø§Ù„Ù‚ÙŠÙ…Ø©</h3>
      <canvas id="valueChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ğŸ“ˆ Ø§Ù„Ø±Ø¨Ø­</h3>
      <canvas id="profitChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ğŸ“‰ Ø§Ù„ØªØºÙŠÙŠØ±</h3>
      <canvas id="changeChart"></canvas>
    </div>
  </div>

  <h2>ğŸ“‘ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
  <div id="transactions">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©.</div>

  <h2>ğŸ“º Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h2>
  <div id="prices">(Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø³Ù†Ø¶ÙŠÙÙ‡Ø§)</div>

<script>
const nf = new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2});
const fmt = v => "Ø¯.Ø¥ " + nf.format(v);

const sampleData = [
  {symbol:"ADIB", qty:200, buy:21.6, current:22.78},
  {symbol:"DIB", qty:150, buy:9.9, current:10.2},
  {symbol:"EAND", qty:100, buy:16.5, current:15.8},
  {symbol:"ADIB", qty:100, buy:12.7, current:22.78},
];

let data = [...sampleData];

function renderTable(rows){
  const body=document.getElementById("tableBody");
  body.innerHTML="";
  let sumQty=0,sumTrade=0,sumCost=0,sumValue=0,sumProfit=0,sumBuyCost=0,sumBuyQty=0;
  rows.forEach(r=>{
    const trade=r.qty*r.buy;
    const cost=trade;
    const value=r.qty*r.current;
    const profit=value-cost;
    const change=((r.current-r.buy)/r.buy*100).toFixed(2);
    sumQty+=r.qty; sumTrade+=trade; sumCost+=cost; sumValue+=value; sumProfit+=profit;
    sumBuyCost+=r.buy*r.qty; sumBuyQty+=r.qty;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.symbol}</td>
      <td>${nf.format(r.qty)}</td>
      <td>${nf.format(r.buy)}</td>
      <td>${nf.format(r.current)}</td>
      <td>${fmt(trade)}</td>
      <td>${fmt(cost)}</td>
      <td>${fmt(value)}</td>
      <td class="${profit>=0?'positive':'negative'}">${fmt(profit)}</td>
      <td class="${change>=0?'positive':'negative'}">${change>=0?'â¬†ï¸':'â¬‡ï¸'} ${change}%</td>
    `;
    body.appendChild(tr);
  });
  document.getElementById("sumQty").textContent=nf.format(sumQty);
  document.getElementById("avgBuy").textContent=sumBuyQty? nf.format(sumBuyCost/sumBuyQty):"â€”";
  document.getElementById("sumTrade").textContent=fmt(sumTrade);
  document.getElementById("sumCost").textContent=fmt(sumCost);
  document.getElementById("sumValue").textContent=fmt(sumValue);
  document.getElementById("sumProfit").textContent=fmt(sumProfit);
}

function renderDashboard(rows){
  const ctxs=["qtyChart","valChart","tradeChart","costChart","valueChart","profitChart","changeChart"];
  ctxs.forEach(id=>{
    const ctx=document.getElementById(id);
    if(ctx.chart) ctx.chart.destroy();
    const labels=[...new Set(rows.map(r=>r.symbol))];
    const agg={}; labels.forEach(l=>agg[l]=0);
    rows.forEach(r=>{
      const trade=r.qty*r.buy;
      const cost=trade;
      const value=r.qty*r.current;
      const profit=value-cost;
      const change=value-cost; // Ù„Ø§Ø­Ø¸: Ù‡Ù†Ø§ Ù†Ø¹Ø±Ø¶ ÙƒÙ‚ÙŠÙ…Ø© Ø¨Ø¯Ù„ Ù†Ø³Ø¨Ø©
      if(id==="qtyChart") agg[r.symbol]+=r.qty;
      else if(id==="valChart") agg[r.symbol]+=value;
      else if(id==="tradeChart") agg[r.symbol]+=trade;
      else if(id==="costChart") agg[r.symbol]+=cost;
      else if(id==="valueChart") agg[r.symbol]+=value;
      else if(id==="profitChart") agg[r.symbol]+=profit;
      else if(id==="changeChart") agg[r.symbol]+=change;
    });
    const values=labels.map(l=>agg[l]);
    ctx.chart=new Chart(ctx,{
      type:"doughnut",
      data:{labels:labels, datasets:[{data:values}]},
      options:{
        plugins:{
          tooltip:{callbacks:{label:ctx=>{
            return `${ctx.label}: ${fmt(ctx.raw)}`;
          }}},
          legend:{labels:{generateLabels(chart){
            const d=chart.data;
            return d.labels.map((l,i)=>({
              text:`${l}: ${fmt(d.datasets[0].data[i])}`,
              fillStyle:chart.data.datasets[0].backgroundColor? chart.data.datasets[0].backgroundColor[i] : undefined
            }));
          }}}
        }
      }
    });
  });
}

renderTable(data);
renderDashboard(data);
</script>
</body>
</html>
