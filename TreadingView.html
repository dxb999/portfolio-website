<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UAE Market Movers â€” Ø´Ø¨ÙŠÙ‡ TradingView</title>
<style>
  :root{--bg:#fff;--fg:#111;--muted:#666;--line:#e9e9e9;--accent:#0a8f22;--down:#d01919}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--fg)}
  header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  header h1{font-size:18px;margin:0}
  .toolbar{display:flex;gap:8px;align-items:center;margin-inline-start:auto}
  .toolbar select,.toolbar input{padding:8px 10px;border:1px solid var(--line);border-radius:8px;font-size:14px}
  .tabs{display:flex;gap:6px;padding:10px 16px;border-bottom:1px solid var(--line);flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:20px;cursor:pointer;font-size:14px;background:#fafafa}
  .tab.active{background:#eef7ff;border-color:#cfe7ff}
  .wrap{padding:12px 16px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center;font-size:14px;white-space:nowrap}
  th{position:sticky;top:0;background:#f9f9f9;z-index:2}
  th.sort{cursor:pointer}
  th.sort::after{content:" â†•";color:var(--muted);font-weight:normal}
  .pos{color:var(--accent)} .neg{color:var(--down)} .muted{color:var(--muted)}
  .status{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px;color:var(--muted);font-size:13px}
  .chip{padding:4px 8px;border:1px solid var(--line);border-radius:12px;font-size:12px}
  .footer{padding:12px 16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<header>
  <h1>ğŸ“Š UAE Market Movers</h1>
  <div class="toolbar">
    <select id="exchange">
      <option value="ALL">Ø§Ù„ÙƒÙ„: ADX + DFM</option>
      <option value="ADX">Ø£Ø¨ÙˆØ¸Ø¨ÙŠ â€” ADX</option>
      <option value="DFM">Ø¯Ø¨ÙŠ â€” DFM</option>
    </select>
    <input id="search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù…Ø² Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…â€¦"/>
    <select id="refresh">
      <option value="60000">ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©</option>
      <option value="30000">ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©</option>
      <option value="120000">ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</option>
      <option value="0">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</option>
    </select>
  </div>
</header>

<div class="tabs">
  <button class="tab active" data-view="gainers">Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø±ØªÙØ§Ø¹Ù‹Ø§</button>
  <button class="tab" data-view="losers">Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ù†Ø®ÙØ§Ø¶Ù‹Ø§</button>
  <button class="tab" data-view="active">Ø£Ù†Ø´Ø· ØªØ¯Ø§ÙˆÙ„Ù‹Ø§</button>
  <span class="chip" id="countChip">â€”</span>
</div>

<div class="wrap">
  <div class="status">
    <div id="statusText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦</div>
    <div id="lastUpdate">â€”</div>
  </div>

  <div style="overflow:auto">
    <table id="grid">
      <thead>
        <tr>
          <th class="sort" data-k="name">Ø§Ù„Ø±Ù…Ø²</th>
          <th class="sort" data-k="short_name">Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ø¨ÙˆØ±ØµØ©</th>
          <th class="sort" data-k="close">Ø§Ù„Ø³Ø¹Ø±</th>
          <th class="sort" data-k="change">% Ø§Ù„ØªØºÙŠÙŠØ±</th>
          <th class="sort" data-k="volume">Ø§Ù„Ø­Ø¬Ù…</th>
          <th class="sort" data-k="value_traded">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©</th>
          <th class="sort" data-k="market_cap_basic">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="footer">
  Ù†Ø³Ø®Ø© ÙˆØ§Ø¬Ù‡Ø© Ø´Ø¨ÙŠÙ‡Ø© Ø¨Ù€ TradingView Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ. Ù„Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ ÙŠÙÙ†ØµØ­ Ø¨ÙˆØ³ÙŠØ· (Proxy) Ù…Ø±Ø®Ù‘Øµ/Ù‚Ø§Ù†ÙˆÙ†ÙŠ. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø¨ÙŠ Ù…Ø­Ø¯ÙˆØ¯Ø© Ø¹Ø¨Ø± Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø±.
</div>

<script>
/* ===================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===================== */

/* Ù…Ù„Ø§Ø­Ø¸Ø©: TradingView ÙŠÙØ±Ø¶ CORS. Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù†Ø³ØªØ¹Ù…Ù„ AllOrigins ÙƒÙ€ Proxy Ø¹Ø§Ù….
   Ø§Ù„Ø£ÙØ¶Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ ØªØ¨Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ø¥Ù„Ù‰ proxy Ø®Ø§Øµ Ø¨Ùƒ (Cloudflare Worker / Apps Script)
   Ø¨Ø­ÙŠØ« ÙŠØµØ¨Ø­: const PROXY = "https://YOUR_WORKER.workers.dev/tv-scan?endpoint="; */
const PROXY = "https://api.allorigins.win/raw?url=";

/* Endpoints Ù…Ø­ØªÙ…Ù„Ø© Ù„Ø¯Ù‰ TradingView Ù„Ù„Ø³ÙƒØ§Ù†Ø± (ØºÙŠØ± Ù…ÙˆØ«Ù‚Ø© ÙˆÙ‚Ø¯ ØªØªØºÙŠØ±) */
const TV_BASES = [
  "https://scanner.tradingview.com/middle_east/scan",
  "https://scanner.tradingview.com/ae/scan",
  "https://scanner.tradingview.com/arabia/scan",
  "https://scanner.tradingview.com/uae/scan",
  "https://scanner.tradingview.com/europe/scan"
];

/* Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */
const COLUMNS = ["name","short_name","exchange","close","change","volume","Value.Traded","market_cap_basic"];

/* ÙÙ„ØªØ± Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª */
const FILTER = [
  { left:"type", operation:"in_range", right:["stock"] },
  { left:"exchange", operation:"in_range", right:["DFM","ADX"] }
];

/* Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø© (ØªØ±Ù‚ÙŠÙ…) */
const PAGE = 500;

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Fallback) Ù„Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø­ÙŠ */
const FALLBACK = [
  { name:"ADX:FAB", short_name:"FAB", exchange:"ADX", close:18.2, change:0.85, volume:1750000, value_traded:32000000, market_cap_basic:2.7e11 },
  { name:"ADX:ADIB", short_name:"ADIB", exchange:"ADX", close:22.8, change:-0.35, volume:980000, value_traded:21000000, market_cap_basic:9.1e10 },
  { name:"ADX:ALDAR", short_name:"ALDAR", exchange:"ADX", close:7.45, change:1.20, volume:5250000, value_traded:39000000, market_cap_basic:5.0e10 },
  { name:"DFM:EMAAR", short_name:"EMAAR", exchange:"DFM", close:8.15, change:0.40, volume:4100000, value_traded:33000000, market_cap_basic:8.8e10 },
  { name:"DFM:DIB", short_name:"DIB", exchange:"DFM", close:9.85, change:-0.55, volume:6200000, value_traded:61000000, market_cap_basic:6.2e10 },
  { name:"DFM:DEWA", short_name:"DEWA", exchange:"DFM", close:2.59, change:0.00, volume:8400000, value_traded:21700000, market_cap_basic:1.6e11 }
];

/* ===================== Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© ===================== */

let RAW = [];          // ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ
let VIEW = "gainers";  // ØªØ¨ÙˆÙŠØ¨ Ù…Ø®ØªØ§Ø±
let SORT = { k:"change", dir:"desc" }; // ÙØ±Ø² Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ø­Ø³Ø¨ %Ø§Ù„ØªØºÙŠÙŠØ± ØªÙ†Ø§Ø²Ù„ÙŠ
let AUTO_TMR = null;

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

$("#exchange").addEventListener("change", render);
$("#search").addEventListener("input", render);
$("#refresh").addEventListener("change", () => setAutoRefresh(+$("#refresh").value));
$$(".tab").forEach(t => t.addEventListener("click", e=>{
  $$(".tab").forEach(x=>x.classList.remove("active"));
  e.currentTarget.classList.add("active");
  VIEW = e.currentTarget.dataset.view;
  // ØºÙŠÙ‘Ø± Ø§Ù„ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  if (VIEW==="gainers") SORT = {k:"change", dir:"desc"};
  if (VIEW==="losers")  SORT = {k:"change", dir:"asc"};
  if (VIEW==="active")  SORT = {k:"value_traded", dir:"desc"};
  render();
}));
$$("th.sort").forEach(th => th.addEventListener("click", ()=>{
  const k = th.dataset.k;
  SORT = (SORT.k===k) ? {k, dir:(SORT.dir==="asc"?"desc":"asc")} : {k, dir:"desc"};
  render();
}));

async function loadAll() {
  setStatus("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦");
  RAW = [];
  for (const base of TV_BASES) {
    try {
      let from = 0, gotAny = false;
      while (true) {
        const payload = {
          filter: FILTER,
          options: { lang: "en" },
          symbols: { query: { types: [] }, tickers: [] },
          columns: COLUMNS,
          sort: { sortBy: "name", sortOrder: "asc" },
          range: [from, from + PAGE]
        };
        const url = PROXY + encodeURIComponent(base);
        const res = await fetch(url, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error("HTTP "+res.status);
        const json = await res.json();

        const rows = json?.data || [];
        if (!rows.length) break;

        // ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØµÙŠØºØ© (s/d) â†’ ÙƒØ§Ø¦Ù†Ø§Øª
        const norm = rows.map(item=>{
          if (item.s && item.d) {
            const obj = { name:item.s };
            // ØªØ·Ø§Ø¨Ù‚ ØªØ±ØªÙŠØ¨ COLUMNS
            obj.short_name = item.d[1];
            obj.exchange = item.d[2];
            obj.close = item.d[3];
            obj.change = item.d[4];
            obj.volume = item.d[5];
            obj["Value.Traded"] = item.d[6];
            obj.market_cap_basic = item.d[7];
            return normalize(obj);
          }
          return normalize(item);
        });

        RAW.push(...norm);
        gotAny = true;
        if (rows.length < PAGE) break;
        from += PAGE;
        await sleep(200);
      }
      if (gotAny) break; // Ø£ÙˆÙ„ endpoint ÙŠØ¹Ø·ÙŠÙ†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙƒØªÙÙŠ Ø¨Ù‡
    } catch (e) {
      // Ø¬Ø±Ù‘Ø¨ endpoint Ø§Ù„ØªØ§Ù„ÙŠ
      console.warn("Fail on", base, e.message);
    }
  }
  if (!RAW.length) {
    // ÙØ´Ù„ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ â†’ Ø§Ø³ØªØ¹Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    RAW = FALLBACK.map(normalize);
    setStatus("Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø­ÙŠ)"); 
  } else {
    setStatus("ØªÙ… Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ù…ØµØ¯Ø± Ø­ÙŠ (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø¨ÙŠ Ù…Ø­Ø¯ÙˆØ¯Ø©)");
  }
  $("#lastUpdate").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: " + new Date().toLocaleTimeString("ar-AE");
  render();
}

function normalize(r){
  return {
    name: r.name || "",
    short_name: r.short_name || "",
    exchange: r.exchange || (r.name.includes(":") ? r.name.split(":")[0] : ""),
    close: num(r.close),
    change: num(r.change),
    volume: num(r.volume),
    value_traded: num(r["Value.Traded"] || r.value_traded),
    market_cap_basic: num(r.market_cap_basic)
  };
}

function render(){
  const ex = $("#exchange").value;
  const q = $("#search").value.trim().toLowerCase();

  let rows = RAW.slice();

  if (ex !== "ALL") rows = rows.filter(r => (r.exchange||"").toUpperCase() === ex);
  if (q) rows = rows.filter(r => (r.name+" "+r.short_name).toLowerCase().includes(q));

  if (VIEW === "gainers") rows = rows.filter(r => isFinite(r.change)).sort((a,b)=> b.change - a.change);
  if (VIEW === "losers")  rows = rows.filter(r => isFinite(r.change)).sort((a,b)=> a.change - b.change);
  if (VIEW === "active")  rows = rows.sort((a,b)=> (b.value_traded||0) - (a.value_traded||0));

  if (SORT && SORT.k){
    rows = rows.sort((a,b)=>{
      const k = SORT.k, dir = SORT.dir==="asc"?1:-1;
      return ((a[k]||0) - (b[k]||0)) * dir;
    });
  }

  // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const tb = $("#grid tbody");
  tb.innerHTML = "";
  for (const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.name)}</td>
      <td>${esc(r.short_name) || "â€”"}</td>
      <td>${esc(r.exchange) || "â€”"}</td>
      <td>${fmt(r.close)}</td>
      <td class="${(r.change||0)>=0 ? 'pos':'neg'}">${isFinite(r.change)? r.change.toFixed(2):"â€”"}</td>
      <td>${fmtInt(r.volume)}</td>
      <td>${fmtInt(r.value_traded)}</td>
      <td>${fmtInt(r.market_cap_basic)}</td>
    `;
    tb.appendChild(tr);
  }
  $("#countChip").textContent = `Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${rows.length}`;
}

function setAutoRefresh(ms){
  if (AUTO_TMR){ clearInterval(AUTO_TMR); AUTO_TMR=null; }
  if (ms>0){ AUTO_TMR = setInterval(loadAll, ms); }
}

function setStatus(t){ $("#statusText").textContent = t; }
function num(v){ const n = Number(v); return isFinite(n)? n : null; }
function fmt(v){ return v==null? "â€”" : Number(v).toLocaleString("en-US"); }
function fmtInt(v){ return v==null? "â€”" : Math.round(v).toLocaleString("en-US"); }
function esc(s){ return (s??"").toString().replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m])); }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ */
loadAll();
setAutoRefresh(+$("#refresh").value);
</script>
</body>
</html>
