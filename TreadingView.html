<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†ØµØ© Ù…Ø­ÙØ¸ØªÙŠ â€“ HTML ÙˆØ§Ø­Ø¯</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #131a2a;
      --muted: #a5b0c2;
      --text: #eef1f7;
      --accent: #5eead4;
      --accent-2: #60a5fa;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    .light {
      --bg: #f6f8fc;
      --card: #ffffff;
      --muted: #5b667a;
      --text: #0b1220;
      --accent: #0ea5e9;
      --accent-2: #8b5cf6;
      --danger: #b91c1c;
      --success: #15803d;
      --warning: #b45309;
      --shadow: 0 10px 24px rgba(2,6,23,.12);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Arial;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(59,130,246,.15), transparent 60%), var(--bg);
      color: var(--text);
    }

    .container { max-width: 1200px; padding: 24px; margin: 0 auto; }

    header {
      display: grid; gap: 16px;
    }

    .title-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    h1 { margin: 0; font-size: 28px; letter-spacing: .3px; }

    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white; border: none; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer;
      box-shadow: var(--shadow);
    }
    .btn.ghost { background: transparent; color: var(--text); border: 1px solid rgba(255,255,255,.15); }
    .btn.danger { background: linear-gradient(135deg, #ef4444, #f97316); }
    .btn.flat { background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,.1); }

    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }

    @media (min-width: 900px){
      .grid { grid-template-columns: 1.2fr .8fr; }
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0) 40%), var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 16px; box-shadow: var(--shadow);
    }

    /* KPI cards */
    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); }
    @media (min-width: 680px){ .kpis { grid-template-columns: repeat(4, 1fr); } }
    .kpi { padding: 14px; border-radius: 14px; background: rgba(255,255,255,.04); border: 1px dashed rgba(255,255,255,.12); }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 22px; font-weight: 800; margin-top: 6px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; font-weight: 700; font-size: 12px; padding: 6px 10px; border-radius: 999px; }
    .chip.pos { background: rgba(34,197,94,.14); color: #86efac; }
    .chip.neg { background: rgba(239,68,68,.14); color: #fecaca; }
    .chip.neu { background: rgba(234,179,8,.14); color: #fde68a; }

    /* Add form */
    .add-form { display: grid; gap: 8px; grid-template-columns: repeat(8, 1fr); align-items: end; }
    .add-form .field { display: grid; gap: 6px; }
    .add-form label { font-size: 12px; color: var(--muted); }
    .add-form input, .add-form select, .toolbar input {
      padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text);
    }
    .add-form input::placeholder { color: #93a3b8; }
    .add-form .wide { grid-column: span 2; }
    .add-form .xwide { grid-column: span 3; }
    .add-form .btn { grid-column: span 2; height: 40px; }
    @media (max-width: 980px){ .add-form { grid-template-columns: repeat(2, 1fr); } .add-form .btn { grid-column: span 2; } }

    /* Table */
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .toolbar .left, .toolbar .right { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .toolbar .toggle { padding: 8px 10px; border-radius: 10px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); cursor: pointer; }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      position: sticky; top: 0; z-index: 1;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0) 30%), var(--card);
      color: var(--muted); font-weight: 700; text-align: right; font-size: 12px; letter-spacing: .2px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      padding: 10px; white-space: nowrap;
    }
    tbody td { border-bottom: 1px dashed rgba(255,255,255,.08); padding: 8px 10px; vertical-align: middle; }
    tbody tr:hover { background: rgba(255,255,255,.03); }

    .sym { display: grid; gap: 2px; }
    .sym .t { font-weight: 800; }
    .sym .s { color: var(--muted); font-size: 12px; }
    .num { text-align: left; font-variant-numeric: tabular-nums; direction: ltr; }
    .pct.pos { color: #86efac; font-weight: 700; }
    .pct.neg { color: #fecaca; font-weight: 700; }

    .input { width: 110px; }
    .input.small { width: 84px; }
    .input.wide { width: 140px; }
    .row-actions { display: flex; gap: 6px; }
    .mini { padding: 6px 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text); cursor: pointer; font-size: 12px; }
    .mini.delete { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.4); }

    .progress {
      width: 120px; height: 8px; background: rgba(255,255,255,.08); border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,.12);
    }
    .progress > span { display: block; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    /* Right column */
    .panel { display: grid; gap: 12px; }

    .donut {
      --size: 160px;
      width: var(--size); height: var(--size);
      border-radius: 50%;
      background: conic-gradient(#60a5fa 0 var(--a1), #22c55e var(--a1) var(--a2), #f59e0b var(--a2) var(--a3), #ef4444 var(--a3) 360deg);
      position: relative; margin: 12px auto;
      box-shadow: var(--shadow);
    }
    .donut::after {
      content: ""; position: absolute; inset: 18%; border-radius: 50%; background: var(--card); border: 1px solid rgba(255,255,255,.1);
    }
    .legend { display: grid; gap: 6px; }
    .legend .item { display: flex; align-items: center; gap: 8px; justify-content: space-between; }
    .legend .tag { display: inline-block; width: 12px; height: 12px; border-radius: 3px; }

    .whatif { display: grid; gap: 8px; }
    .range { accent-color: var(--accent-2); }

    footer { margin: 20px 0 0; color: var(--muted); font-size: 12px; text-align: center; }

    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div class="title-row">
        <h1>ğŸ’¼ Ù…Ù†ØµØ© Ù…Ø­ÙØ¸ØªÙŠ</h1>
        <div class="controls">
          <button class="btn flat" id="toggleTheme">ğŸŒ— ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„/Ø§Ù„Ù†Ù‡Ø§Ø±</button>
          <button class="btn ghost" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
          <label class="btn ghost" for="importFile" style="cursor:pointer">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
          <input id="importFile" type="file" accept="application/json" hidden>
          <button class="btn danger" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        </div>
      </div>

      <div class="kpis" id="kpis">
        <div class="kpi"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</div><div class="value" id="kpiValue">â€”</div></div>
        <div class="kpi"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</div><div class="value" id="kpiCost">â€”</div></div>
        <div class="kpi"><div class="label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</div><div class="value" id="kpiPnL">â€”</div></div>
        <div class="kpi"><div class="label">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</div><div class="value" id="kpiReturn">â€”</div></div>
      </div>

      <div class="card">
        <form class="add-form" id="addForm" onsubmit="return false;">
          <div class="field">
            <label>Ø§Ù„Ø±Ù…Ø²</label>
            <input id="fSymbol" placeholder="ADIB / DIB / EMAAR" required />
          </div>
          <div class="field xwide">
            <label>Ø§Ù„Ø´Ø±ÙƒØ©</label>
            <input id="fName" placeholder="Ù…ØµØ±Ù Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ" />
          </div>
          <div class="field">
            <label>Ø§Ù„Ø³ÙˆÙ‚</label>
            <select id="fEx">
              <option value="ADX">ADX</option>
              <option value="DFM">DFM</option>
              <option value="NASDAQ">NASDAQ</option>
              <option value="LSE">LSE</option>
            </select>
          </div>
          <div class="field">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
            <input id="fQty" type="number" step="1" min="0" placeholder="100" />
          </div>
          <div class="field">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
            <input id="fBuy" type="number" step="0.0001" min="0" placeholder="10.50" />
          </div>
          <div class="field">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚</label>
            <input id="fMkt" type="number" step="0.0001" min="0" placeholder="11.20" />
          </div>
          <div class="field">
            <label>ØªÙˆØ²ÙŠØ¹/Ø³Ù‡Ù… (Ø³Ù†ÙˆÙŠ)</label>
            <input id="fDps" type="number" step="0.0001" min="0" placeholder="0.45" />
          </div>
          <button class="btn" id="addBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ø¬Ù„</button>
        </form>
      </div>
    </header>

    <main class="grid">
      <!-- Left: table -->
      <section class="card">
        <div class="toolbar">
          <div class="left">
            <input id="search" placeholder="Ø¨Ø­Ø«: Ø±Ù…Ø²/Ø§Ø³Ù…" />
            <select id="filterEx">
              <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚</option>
              <option value="ADX">ADX</option>
              <option value="DFM">DFM</option>
              <option value="NASDAQ">NASDAQ</option>
              <option value="LSE">LSE</option>
            </select>
            <span class="muted">* Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„</span>
          </div>
          <div class="right">
            <div class="toggle"><span id="currencyLabel">Ø¯.Ø¥</span></div>
            <button class="btn flat" id="bulkBtn">ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø³Ø¹Ø§Ø±</button>
          </div>
        </div>

        <div style="overflow:auto; max-height: 520px; border-radius: 12px;">
          <table id="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Ø§Ù„Ø´Ø±ÙƒØ© / Ø§Ù„Ø±Ù…Ø²</th>
                <th>Ø§Ù„Ø³ÙˆÙ‚</th>
                <th class="num">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th class="num">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                <th class="num">Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚</th>
                <th class="num">Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                <th class="num">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                <th class="num">Ø§Ù„Ø±Ø¨Ø­</th>
                <th class="num">% Ø§Ù„Ø¹Ø§Ø¦Ø¯</th>
                <th class="num">DPS</th>
                <th class="num">Ø¹Ø§Ø¦Ø¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹</th>
                <th class="num">Ø§Ù„Ù‡Ø¯Ù</th>
                <th>Ø§Ù„ØªÙ‚Ø¯Ù…</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Right: panels -->
      <aside class="panel">
        <div class="card">
          <h3 style="margin:0 0 8px">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
          <div class="donut" id="donut" title="Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ø³Ø¨ÙŠ Ù„Ù„ÙˆØ²Ù†"></div>
          <div class="legend" id="legend"></div>
        </div>

        <div class="card whatif">
          <h3 style="margin:0">ğŸ§ª Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ù…Ø§Ø°Ø§ Ù„Ùˆ</h3>
          <div class="muted">Ø­Ø±Ù‘Ùƒ Ø§Ù„Ø´Ø±ÙŠØ· Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø±ØªÙØ§Ø¹/Ø§Ù†Ø®ÙØ§Ø¶ Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚.</div>
          <input id="whatIf" type="range" min="-20" max="20" step="1" value="0" class="range" />
          <div><b id="whatIfLbl">0%</b> ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± â€¢ ØµØ§ÙÙŠ Ø§Ù„Ø£Ø«Ø±: <b id="whatIfImpact">â€”</b></div>
        </div>

        <div class="card" id="bulkPanel" style="display:none">
          <h3 style="margin:0 0 8px">âš¡ï¸ ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ Ù„Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
          <div class="muted">Ø§Ù„ØµÙ‚ Ø£Ø³Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø­Ùˆ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«:
            <br><code>ADIB, 22.80</code> Ø£Ùˆ <code>DIB 13.45</code>
          </div>
          <textarea id="bulkBox" rows="6" style="width:100%; margin-top:8px; padding:10px; border-radius: 10px; background: rgba(255,255,255,.04); color: var(--text); border:1px solid rgba(255,255,255,.12);"></textarea>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <button class="btn" id="applyBulk">ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn ghost" id="closeBulk">Ø¥ØºÙ„Ø§Ù‚</button>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      <div>âš ï¸ ØªÙ†ÙˆÙŠÙ‡: Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø£Ù…Ø«Ù„Ø© ÙÙ‚Ø·. Ø­Ø¯Ù‘Ø«Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ùˆ Ø¹Ø¨Ø± "Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø±ÙŠØ¹".</div>
    </footer>
  </div>

  <script>
    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];

    // ========= State =========
    const LS_KEY = 'portfolioData.v1';
    const state = {
      currency: 'Ø¯.Ø¥',
      items: []
    };

    const sample = [
      { symbol:'ADIB', name:'Ù…ØµØ±Ù Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ', ex:'ADX', qty:200, buy:21.60, mkt:22.80, dps:0.86, target:25, notes:'' },
      { symbol:'DIB', name:'Ø¨Ù†Ùƒ Ø¯Ø¨ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ', ex:'DFM', qty:350, buy:10.20, mkt:12.90, dps:0.40, target:14, notes:'' },
      { symbol:'EMAAR', name:'Ø¥Ø¹Ù…Ø§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠØ©', ex:'DFM', qty:180, buy:7.50, mkt:8.20, dps:0.25, target:9, notes:'' },
      { symbol:'AIRARABIA', name:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ø·ÙŠØ±Ø§Ù†', ex:'DFM', qty:500, buy:2.60, mkt:3.10, dps:0.09, target:3.6, notes:'' },
      { symbol:'ADNOCDIST', name:'Ø£Ø¯Ù†ÙˆÙƒ Ù„Ù„ØªÙˆØ²ÙŠØ¹', ex:'ADX', qty:300, buy:4.20, mkt:4.50, dps:0.33, target:5.2, notes:'' },
      { symbol:'EAND', name:'e& Ø§ØªØµØ§Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ù‹Ø§', ex:'ADX', qty:120, buy:16.50, mkt:17.30, dps:0.80, target:19, notes:'' },
      { symbol:'DANA', name:'Ø¯Ø§Ù†Ø© ØºØ§Ø²', ex:'ADX', qty:1000, buy:0.94, mkt:0.98, dps:0.05, target:1.2, notes:'' },
      { symbol:'MULTIPLY', name:'Ù…ÙˆÙ„ØªÙŠØ¨Ù„Ø§ÙŠ', ex:'ADX', qty:600, buy:3.10, mkt:3.05, dps:0.10, target:3.7, notes:'' }
    ];

    // ========= Utils =========
    const nf = new Intl.NumberFormat('ar-AE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const pf = new Intl.NumberFormat('ar-AE', { minimumFractionDigits: 2, maximumFractionDigits: 2, style:'percent' });

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        try { Object.assign(state, JSON.parse(raw)); } catch(e){ console.warn('LS parse', e); }
      } else {
        state.items = sample;
        persist();
      }
    }
    function persist(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

    function compute(){
      const rows = state.items.map(it => {
        const cost = (+it.qty||0) * (+it.buy||0);
        const val = (+it.qty||0) * (+it.mkt||0);
        const pnl = val - cost;
        const ret = cost>0 ? pnl / cost : 0;
        const divYield = (+it.mkt||0)>0 ? (+it.dps||0) / (+it.mkt||0) : 0;
        const annualDiv = (+it.dps||0) * (+it.qty||0);
        const progress = (+it.target||0)>0 ? (+it.mkt||0)/(+it.target||0) : 0;
        return { ...it, cost, val, pnl, ret, divYield, annualDiv, progress };
      });
      const totalCost = sum(rows.map(r=>r.cost));
      const totalVal = sum(rows.map(r=>r.val));
      const totalPnL = totalVal - totalCost;
      const totalRet = totalCost>0 ? totalPnL/totalCost : 0;
      const totalDiv = sum(rows.map(r=>r.annualDiv));
      const portYield = totalVal>0 ? totalDiv/totalVal : 0;
      return { rows, totalCost, totalVal, totalPnL, totalRet, totalDiv, portYield };
    }

    function colorPct(x){ return x>0 ? 'pos' : (x<0 ? 'neg' : 'neu'); }

    // ========= Render =========
    function render(){
      const q = $('#search').value.trim().toLowerCase();
      const exFilter = $('#filterEx').value;
      const { rows, totalCost, totalVal, totalPnL, totalRet } = compute();

      // KPI
      $('#kpiValue').textContent = fmt(totalVal);
      $('#kpiCost').textContent = fmt(totalCost);
      $('#kpiPnL').innerHTML = `${fmt(totalPnL)} <span class="chip ${colorPct(totalPnL)}">${totalPnL>0?'â–²':'â–¼'} ${nf.format(totalRet*100)}%</span>`;
      $('#kpiReturn').textContent = nf.format(totalRet*100) + '%';

      // Table
      const tbody = $('#tbody');
      tbody.innerHTML = '';

      rows
        .map((r,i)=>({r,i}))
        .filter(({r})=>{
          const hit = r.symbol.toLowerCase().includes(q) || (r.name||'').toLowerCase().includes(q);
          const hitEx = !exFilter || r.ex===exFilter;
          return hit && hitEx;
        })
        .forEach(({r,i}, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>
              <div class="sym">
                <div class="t">${r.name||''}</div>
                <div class="s">${r.symbol||''}</div>
              </div>
            </td>
            <td>${r.ex||''}</td>
            <td class="num">${inputNum('qty', r.qty, i, 'small')}</td>
            <td class="num">${inputNum('buy', r.buy, i)}</td>
            <td class="num">${inputNum('mkt', r.mkt, i)}</td>
            <td class="num">${fmt(r.cost)}</td>
            <td class="num">${fmt(r.val)}</td>
            <td class="num ${colorPct(r.pnl)}">${fmt(r.pnl)}</td>
            <td class="num ${colorPct(r.ret)}">${nf.format(r.ret*100)}%</td>
            <td class="num">${inputNum('dps', r.dps, i, 'small')}</td>
            <td class="num">${nf.format(r.divYield*100)}%</td>
            <td class="num">${inputNum('target', r.target, i, 'small')}</td>
            <td><div class="progress"><span style="width:${Math.max(0, Math.min(100, Math.round((r.progress||0)*100)))}%"></span></div></td>
            <td>${inputText('notes', r.notes||'', i, 'wide')}</td>
            <td class="row-actions">
              <button class="mini delete" data-del="${i}">Ø­Ø°Ù</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      // Donut & legend
      renderDonut(rows);

      // Bind deletes
      $$('button[data-del]').forEach(btn=>btn.onclick = (e)=>{
        const idx = +e.currentTarget.getAttribute('data-del');
        state.items.splice(idx,1); persist(); render();
      });

      // Bind inputs
      $$('input[data-idx]').forEach(inp=>{
        inp.oninput = (e)=>{
          const idx = +e.target.getAttribute('data-idx');
          const key = e.target.getAttribute('data-key');
          const val = e.target.type==='number' ? +e.target.value : e.target.value;
          state.items[idx][key] = (isFinite(val) ? val : 0);
          persist(); render();
        };
      });
    }

    function inputNum(key, val, idx, size=''){
      return `<input class="input ${size}" type="number" step="0.0001" data-idx="${idx}" data-key="${key}" value="${val ?? ''}">`;
    }
    function inputText(key, val, idx, size=''){
      return `<input class="input ${size}" type="text" data-idx="${idx}" data-key="${key}" value="${escapeHtml(val)}">`;
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    function fmt(x){ if(!isFinite(+x)) return 'â€”'; return state.currency + ' ' + nf.format(+x); }

    function renderDonut(rows){
      const weights = rows.map(r=>r.val);
      const total = sum(weights);
      const angles = [];
      let acc = 0;
      for(let i=0;i<weights.length;i++){
        const a = total>0 ? (weights[i]/total)*360 : 0;
        acc += a; angles.push(acc);
      }
      const donut = $('#donut');
      donut.style.setProperty('--a1', (angles[0]||0)+'deg');
      donut.style.setProperty('--a2', (angles[1]||angles[0]||0)+'deg');
      donut.style.setProperty('--a3', (angles[2]||angles[1]||angles[0]||0)+'deg');
      // Legend (first 4 items colored, rest grouped)
      const colors = ['#60a5fa','#22c55e','#f59e0b','#ef4444','#a78bfa','#14b8a6','#f97316','#84cc16'];
      const legend = $('#legend');
      legend.innerHTML = '';
      rows.forEach((r,i)=>{
        const it = document.createElement('div'); it.className='item';
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
        const tag = document.createElement('span'); tag.className='tag'; tag.style.background = colors[i % colors.length];
        const name = document.createElement('span'); name.textContent = `${r.symbol} Â· ${r.ex}`;
        left.append(tag, name);
        const weight = document.createElement('b'); weight.textContent = total>0 ? (nf.format((r.val/total)*100)+'%') : 'â€”';
        it.append(left, weight); legend.append(it);
      });
    }

    // ========= Events =========
    $('#toggleTheme').onclick = ()=>{
      document.body.classList.toggle('light');
    };

    $('#addBtn').onclick = ()=>{
      const it = {
        symbol: $('#fSymbol').value.trim().toUpperCase(),
        name: $('#fName').value.trim(),
        ex: $('#fEx').value,
        qty: +$('#fQty').value || 0,
        buy: +$('#fBuy').value || 0,
        mkt: +$('#fMkt').value || 0,
        dps: +$('#fDps').value || 0,
        target: 0,
        notes: ''
      };
      if(!it.symbol) return;
      state.items.push(it); persist();
      // clear quick fields
      ['fSymbol','fName','fQty','fBuy','fMkt','fDps'].forEach(id=>$('#'+id).value='');
      render();
    };

    $('#search').oninput = ()=>render();
    $('#filterEx').onchange = ()=>render();

    $('#bulkBtn').onclick = ()=>{ $('#bulkPanel').style.display='block'; $('#bulkBox').focus(); };
    $('#closeBulk').onclick = ()=>{ $('#bulkPanel').style.display='none'; };
    $('#applyBulk').onclick = ()=>{
      const txt = $('#bulkBox').value.trim();
      if(!txt) return;
      const lines = txt.split(/\n|\r/).map(s=>s.trim()).filter(Boolean);
      lines.forEach(line=>{
        const m = line.match(/([A-Za-z\-_.]+)/);
        const num = line.match(/(-?[0-9]+(?:\.[0-9]+)?)/g);
        if(!m || !num) return;
        const sym = m[1].toUpperCase();
        const price = parseFloat(num[num.length-1]);
        const idx = state.items.findIndex(x=>x.symbol.toUpperCase()===sym);
        if(idx>-1){ state.items[idx].mkt = price; }
      });
      persist(); render();
    };

    $('#whatIf').oninput = (e)=>{
      const p = +e.target.value; $('#whatIfLbl').textContent = (p>0?'+':'')+p+'%';
      const { rows, totalVal } = compute();
      const hypot = sum(rows.map(r=> r.qty * (r.mkt*(1+p/100)) ));
      const delta = hypot - totalVal;
      $('#whatIfImpact').textContent = fmt(delta);
    };

    $('#exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'portfolio.json'; a.click();
    };

    $('#importFile').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try {
          const obj = JSON.parse(reader.result);
          if(obj && Array.isArray(obj.items)){
            state.items = obj.items; if(obj.currency) state.currency = obj.currency; persist(); render();
          }
        } catch(err){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); }
      };
      reader.readAsText(f);
    };

    $('#resetBtn').onclick = ()=>{
      if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·ØŸ Ø³ØªÙØ­Ø°Ù Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§.')){
        localStorage.removeItem(LS_KEY); state.items = sample; persist(); render();
      }
    };

    // ========= Init =========
    load(); render();
  </script>
</body>
</html>
