<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>💼 منصة محفظتي</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: 'Tahoma', sans-serif; margin:20px; background:#f5f5f5; color:#333;}
    h1 {text-align:center;}
    .controls {text-align:center; margin-bottom:10px;}
    .btn {padding:6px 12px; margin:3px; border:none; border-radius:6px; cursor:pointer;}
    .btn.ghost {background:#eee;}
    .btn.danger {background:#e74c3c; color:#fff;}
    .btn.flat {background:#3498db; color:#fff;}
    .kpis {display:flex; justify-content:space-around; margin:20px 0; flex-wrap:wrap;}
    .kpi {background:#fff; padding:10px 20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin:5px;}
    table {width:100%; border-collapse:collapse; margin-top:20px; background:#fff;}
    th, td {border:1px solid #ccc; padding:6px; text-align:center;}
    th {background:#eee;}
    tfoot td {font-weight:bold; background:#fafafa;}
    .positive {color:green;}
    .negative {color:red;}
    .filters {margin:10px 0; display:flex; gap:10px; flex-wrap:wrap;}
    .dashboard {display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:30px;}
    .chart-container {background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  </style>
</head>
<body>
  <h1>💼 منصة محفظتي</h1>
  <div class="controls">
    <button class="btn flat" id="toggleTheme">🌗 وضع الليل/النهار</button>
    <button class="btn ghost" id="exportBtn">⬇️ تصدير</button>
    <label class="btn ghost" for="importFile" style="cursor:pointer">⬆️ استيراد</label>
    <input id="importFile" type="file" accept="application/json" hidden>
    <button class="btn danger" id="resetBtn">إعادة ضبط</button>
  </div>

  <div class="kpis" id="kpis">
    <div class="kpi"><div class="label">إجمالي القيمة</div><div class="value" id="kpiValue">—</div></div>
    <div class="kpi"><div class="label">إجمالي التكلفة</div><div class="value" id="kpiCost">—</div></div>
    <div class="kpi"><div class="label">صافي الربح/الخسارة</div><div class="value" id="kpiPnL">—</div></div>
    <div class="kpi"><div class="label">التغيير الكلي</div><div class="value" id="kpiReturn">—</div></div>
  </div>

  <div class="filters" id="columnFilters"></div>
  <input type="text" id="searchInput" placeholder="🔍 بحث: رمز/اسم" style="width:100%;padding:8px;">

  <table id="portfolioTable">
    <thead>
      <tr>
        <th>الرمز</th>
        <th>الكمية</th>
        <th>سعر الشراء</th>
        <th>السعر الحالي</th>
        <th>مبلغ التداول</th>
        <th>التكلفة</th>
        <th>القيمة</th>
        <th>الربح</th>
        <th>التغيير %</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
    <tfoot>
      <tr>
        <td>المجموع</td>
        <td id="sumQty">—</td>
        <td id="avgBuy">—</td>
        <td>—</td>
        <td id="sumTrade">—</td>
        <td id="sumCost">—</td>
        <td id="sumValue">—</td>
        <td id="sumProfit">—</td>
        <td>—</td>
      </tr>
    </tfoot>
  </table>

  <div class="dashboard">
    <div class="chart-container">
      <h3>📊 توزيع عدد الأسهم</h3>
      <canvas id="qtyChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>💰 توزيع القيمة السوقية</h3>
      <canvas id="valChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>💵 مبلغ التداول</h3>
      <canvas id="tradeChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>💸 التكلفة</h3>
      <canvas id="costChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>🏷️ القيمة</h3>
      <canvas id="valueChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>📈 الربح</h3>
      <canvas id="profitChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>📉 التغيير</h3>
      <canvas id="changeChart"></canvas>
    </div>
  </div>

  <h2>📑 الحركات المالية</h2>
  <div id="transactions">لا توجد حركات مسجلة.</div>

  <h2>📺 شاشة الأسعار</h2>
  <div id="prices">(لاحقًا سنضيفها)</div>

<script>
const nf = new Intl.NumberFormat('ar-EG',{maximumFractionDigits:2});
const fmt = v => "د.إ " + nf.format(v);

const sampleData = [
  {symbol:"ADIB", qty:200, buy:21.6, current:22.78},
  {symbol:"DIB", qty:150, buy:9.9, current:10.2},
  {symbol:"EAND", qty:100, buy:16.5, current:15.8},
  {symbol:"ADIB", qty:100, buy:12.7, current:22.78},
];

let data = [...sampleData];

function renderTable(rows){
  const body=document.getElementById("tableBody");
  body.innerHTML="";
  let sumQty=0,sumTrade=0,sumCost=0,sumValue=0,sumProfit=0,sumBuyCost=0,sumBuyQty=0;
  rows.forEach(r=>{
    const trade=r.qty*r.buy;
    const cost=trade;
    const value=r.qty*r.current;
    const profit=value-cost;
    const change=((r.current-r.buy)/r.buy*100).toFixed(2);
    sumQty+=r.qty; sumTrade+=trade; sumCost+=cost; sumValue+=value; sumProfit+=profit;
    sumBuyCost+=r.buy*r.qty; sumBuyQty+=r.qty;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.symbol}</td>
      <td>${nf.format(r.qty)}</td>
      <td>${nf.format(r.buy)}</td>
      <td>${nf.format(r.current)}</td>
      <td>${fmt(trade)}</td>
      <td>${fmt(cost)}</td>
      <td>${fmt(value)}</td>
      <td class="${profit>=0?'positive':'negative'}">${fmt(profit)}</td>
      <td class="${change>=0?'positive':'negative'}">${change>=0?'⬆️':'⬇️'} ${change}%</td>
    `;
    body.appendChild(tr);
  });
  document.getElementById("sumQty").textContent=nf.format(sumQty);
  document.getElementById("avgBuy").textContent=sumBuyQty? nf.format(sumBuyCost/sumBuyQty):"—";
  document.getElementById("sumTrade").textContent=fmt(sumTrade);
  document.getElementById("sumCost").textContent=fmt(sumCost);
  document.getElementById("sumValue").textContent=fmt(sumValue);
  document.getElementById("sumProfit").textContent=fmt(sumProfit);
}

function renderDashboard(rows){
  const ctxs=["qtyChart","valChart","tradeChart","costChart","valueChart","profitChart","changeChart"];
  ctxs.forEach(id=>{
    const ctx=document.getElementById(id);
    if(ctx.chart) ctx.chart.destroy();
    const labels=[...new Set(rows.map(r=>r.symbol))];
    const agg={}; labels.forEach(l=>agg[l]=0);
    rows.forEach(r=>{
      const trade=r.qty*r.buy;
      const cost=trade;
      const value=r.qty*r.current;
      const profit=value-cost;
      const change=value-cost; // لاحظ: هنا نعرض كقيمة بدل نسبة
      if(id==="qtyChart") agg[r.symbol]+=r.qty;
      else if(id==="valChart") agg[r.symbol]+=value;
      else if(id==="tradeChart") agg[r.symbol]+=trade;
      else if(id==="costChart") agg[r.symbol]+=cost;
      else if(id==="valueChart") agg[r.symbol]+=value;
      else if(id==="profitChart") agg[r.symbol]+=profit;
      else if(id==="changeChart") agg[r.symbol]+=change;
    });
    const values=labels.map(l=>agg[l]);
    ctx.chart=new Chart(ctx,{
      type:"doughnut",
      data:{labels:labels, datasets:[{data:values}]},
      options:{
        plugins:{
          tooltip:{callbacks:{label:ctx=>{
            return `${ctx.label}: ${fmt(ctx.raw)}`;
          }}},
          legend:{labels:{generateLabels(chart){
            const d=chart.data;
            return d.labels.map((l,i)=>({
              text:`${l}: ${fmt(d.datasets[0].data[i])}`,
              fillStyle:chart.data.datasets[0].backgroundColor? chart.data.datasets[0].backgroundColor[i] : undefined
            }));
          }}}
        }
      }
    });
  });
}

renderTable(data);
renderDashboard(data);
</script>
</body>
</html>
